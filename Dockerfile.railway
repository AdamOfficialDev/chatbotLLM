# Railway Dockerfile - Fixed for Python 3.11+ externally managed environment
FROM node:18-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-venv \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Create Python virtual environment
RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Copy and install Node.js dependencies
COPY package.json ./
RUN npm install --only=production

# Copy and install Python dependencies using virtual environment
COPY backend/requirements.txt ./backend/
RUN pip install --no-cache-dir -r backend/requirements.txt

# Copy source code
COPY . .

# Build the application
RUN npm run build

# Create startup script
RUN echo '#!/bin/bash\n\
export PATH="/opt/venv/bin:$PATH"\n\
export PORT=${PORT:-3000}\n\
echo "Railway deployment starting on PORT: $PORT"\n\
echo "Python path: $(which python3)"\n\
python3 backend/server.py &\n\
sleep 8\n\
npm start -- --port $PORT --hostname 0.0.0.0\n\
' > start.sh && chmod +x start.sh

EXPOSE $PORT

CMD ["./start.sh"]