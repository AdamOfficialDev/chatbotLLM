# Alternative Railway Dockerfile - More reliable build
FROM node:18-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy and install Node.js dependencies
COPY package.json ./
RUN npm install --only=production

# Copy and install Python dependencies  
COPY backend/requirements.txt ./backend/
RUN pip3 install --no-cache-dir -r backend/requirements.txt

# Copy source code
COPY . .

# Build the application
RUN npm run build

# Create startup script
RUN echo '#!/bin/bash\n\
export PORT=${PORT:-3000}\n\
echo "Railway deployment starting on PORT: $PORT"\n\
python3 backend/server.py &\n\
sleep 8\n\
npm start -- --port $PORT --hostname 0.0.0.0\n\
' > start.sh && chmod +x start.sh

EXPOSE $PORT

CMD ["./start.sh"]